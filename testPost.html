<h1>Car Search</h1>
<table id="table">
  <thead>
  <tr>
      <th>Make</th>
      <th>Model</th>
      <th>Year</th>
      <th>Price</th>
      <th>Engine</th>
      <th>Body Style</th>
      <!-- <th>Likes</th> -->
  </tr>
  </thead>
  <tr id="result"></tr>
  <tbody id="carData"></tbody>
</table>
    <!-- Set label and input ids - allows for use in getInput() function -->
    <label for="make">Make</label>
    <input name="make" id="make">
    <label for="model">Model</label>
    <input name="model" id="model">
    <label for="year">Year</label>
    <input name="year" id="year">
    <label for="price">Price</label>
    <input name="price" id="price">
    <label for="engine">Engine</label>
    <input name="engine" id="engine">
    <label for="body_style">Body Style</label>
    <input name="body_style" id="body_style">
    <button onclick="makeTable(carData)" style="background-color: #ffff; color: black;">Search</button>
    <button onclick="clearTable(carData)" style="background-color: #f2f2f2; color: black">Clear</button>
 <script>
  // prepare HTML result container for new output
  const resultContainer = document.getElementById("result");
  const url = "https://cars.nighthawkcodingsociety.com/api/cars/";

  const headers = {
    method: 'GET',
    cache: 'default',
    mode: 'cors',
    credentials: 'omit', 
    headers: {
      'Content-Type': 'application/json',
    },
  };
  // Set carData to null
  carData = null;

  // Fetch the database
  fetch(url, headers)
    .then(response => {
      console.log("result of fetch " + response.status + " " + response.statusText);
      
      if (response.status != 200) {
        const errorMsg = 'Database response error: ' + response.status;
          console.log(errorMsg);
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.innerHTML = errorMsg;
          tr.appendChild(td);
          
          resultContainer.appendChild(tr);
          return;
      }
      // Debug, check if there is any response
      if( response == null) {
        console.log("Response is null!");
        return;
      }
      // Parse the json and add it to the webpage
      response.json().then(data => {
          console.log({data})
          // Set carData to the data from the database     
          carData=data
          console.log(carData)
      })
  })
    // Checking for errors, more debugging
  .catch(err => {
    console.error(err);
    const tr = document.createElement("tr");
    const td = document.createElement("td");
    td.innerHTML = err;
    tr.appendChild(td);
    resultContainer.appendChild(tr);
  }); 
  // Table creation after search button is pressed
// Table creation after search button is pressed
function makeTable(data){
// Remove current carData - prepare for new search
document.getElementById("carData").remove()
const [desiredMake, desiredModel, desiredPrice, desiredYear, desiredEngine, desiredBodyStyle] = getInput()
const tbody = document.createElement("tbody")
// Set tbody id to carData - ensure that carData is still on page
tbody.id = "carData"
// Iterate over each row from the data in the database
for (const row of data) {

// Filter
// Check if each row value matches user input, skip to the next iteration if there is no match
if (desiredMake && !(row.make.toUpperCase() === desiredMake.toUpperCase()))
continue
if (desiredModel && !(row.model.toUpperCase() === desiredModel.toUpperCase()))
continue
if (desiredPrice && !(row.price <= parseInt(desiredPrice)))
continue
if (desiredYear && !(row.year === parseInt(desiredYear)))
continue          
if (desiredEngine && !(row.engine.toUpperCase() === desiredEngine.toUpperCase()))
continue
if (desiredBodyStyle && !(row.body_style.toUpperCase() === desiredBodyStyle.toUpperCase()))
continue         

// If all values match, create table elements
const tr = document.createElement("tr");
const make = document.createElement("td");
const model = document.createElement("td");
const year = document.createElement("td");
const price = document.createElement("td");
const engine = document.createElement("td");
const body_style = document.createElement("td");

// Set innerHTML to values of make, model, year, etc.
make.innerHTML = row.make;
model.innerHTML = row.model; 
year.innerHTML = row.year; 
price.innerHTML = row.price; 
engine.innerHTML = row.engine; 
body_style.innerHTML = row.body_style; 

tr.appendChild(make);
tr.appendChild(model);
tr.appendChild(year);
tr.appendChild(price);
tr.appendChild(engine);
tr.appendChild(body_style);

tbody.appendChild(tr);
}
// Add the tbody to the table
document.getElementById("table").appendChild(tbody);

// Send a POST request to submit the new car data
const new_car = {
"make": desiredMake,
"model": desiredModel,
"year": desiredYear,
"price": desiredPrice,
"engine": desiredEngine,
"body_style": desiredBodyStyle
};
fetch('https://cars.nighthawkcodingsociety.com/api/cars/', {
method: 'POST',
headers: {
  'Content-Type': 'application/json'
},
body: JSON.stringify(new_car)
})
.then(response => {
console.log('Success:', response);
})
.catch((error) => {
console.error('Error:', error);
});
}
  // Get input from form and return value
  function getInput(){
    let make = document.getElementById("make").value
    let model = document.getElementById("model").value
    let price = document.getElementById("price").value
    let year = document.getElementById("year").value
    let engine = document.getElementById("engine").value
    let body_style = document.getElementById("body_style").value

    if (make === null)
      make = null
    
    if (model === null)
      model = null
    
    if (price === null)
      price = null
    
    if (year === null)
      year = null

    if (engine === null)
      engine = null
    
    if (body_style === null)
      body_style = null
    
    return [make, model, price, year, engine, body_style]
  }
  // Clear table
  function clearTable(){
    document.getElementById("carData").innerHTML = "";
  }

</script>